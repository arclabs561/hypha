name: ci

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91 # Match rust-version
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Check
        run: cargo check --all-targets

      - name: Fmt
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Test
        run: cargo test --all-targets

  netem:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build netem example
        run: cargo build --example netem_node

      - name: Netns + tc netem (TCP)
        timeout-minutes: 6
        shell: bash
        run: |
          set -euo pipefail

          sudo ip netns add hypha_sub
          sudo ip netns add hypha_pub

          cleanup() {
            sudo ip netns del hypha_sub 2>/dev/null || true
            sudo ip netns del hypha_pub 2>/dev/null || true
          }
          trap cleanup EXIT

          sudo ip link add veth_sub type veth peer name veth_pub
          sudo ip link set veth_sub netns hypha_sub
          sudo ip link set veth_pub netns hypha_pub

          sudo ip -n hypha_sub addr add 10.10.0.2/24 dev veth_sub
          sudo ip -n hypha_pub addr add 10.10.0.1/24 dev veth_pub
          sudo ip -n hypha_sub link set lo up
          sudo ip -n hypha_pub link set lo up
          sudo ip -n hypha_sub link set veth_sub up
          sudo ip -n hypha_pub link set veth_pub up

          # Inject modest loss + delay on publisher egress.
          sudo ip netns exec hypha_pub tc qdisc add dev veth_pub root netem loss 5% delay 30ms

          OUTFILE=/tmp/hypha_listen_tcp.txt
          rm -f "$OUTFILE"

          sudo ip netns exec hypha_sub env RUST_LOG=info \
            timeout 45s ./target/debug/examples/netem_node sub tcp 10.10.0.2 /tmp/hypha_sub_tcp "$OUTFILE" &
          SUB_PID=$!

          # Wait for subscriber to write listen addr.
          for _ in $(seq 1 50); do
            if [ -s "$OUTFILE" ]; then
              break
            fi
            sleep 0.1
          done
          if [ ! -s "$OUTFILE" ]; then
            echo "subscriber did not write listen addr"
            kill "$SUB_PID" || true
            exit 1
          fi

          PEER_ADDR="$(<"$OUTFILE")"
          echo "Dialing: $PEER_ADDR"

          sudo ip netns exec hypha_pub env RUST_LOG=info \
            timeout 30s ./target/debug/examples/netem_node pub tcp 10.10.0.1 /tmp/hypha_pub_tcp "$PEER_ADDR"

          wait "$SUB_PID"

      - name: Netns + tc netem (QUIC)
        timeout-minutes: 6
        shell: bash
        run: |
          set -euo pipefail

          sudo ip netns add hypha_sub
          sudo ip netns add hypha_pub

          cleanup() {
            sudo ip netns del hypha_sub 2>/dev/null || true
            sudo ip netns del hypha_pub 2>/dev/null || true
          }
          trap cleanup EXIT

          sudo ip link add veth_sub type veth peer name veth_pub
          sudo ip link set veth_sub netns hypha_sub
          sudo ip link set veth_pub netns hypha_pub

          sudo ip -n hypha_sub addr add 10.20.0.2/24 dev veth_sub
          sudo ip -n hypha_pub addr add 10.20.0.1/24 dev veth_pub
          sudo ip -n hypha_sub link set lo up
          sudo ip -n hypha_pub link set lo up
          sudo ip -n hypha_sub link set veth_sub up
          sudo ip -n hypha_pub link set veth_pub up

          # Inject higher delay + a bit of loss on publisher egress.
          sudo ip netns exec hypha_pub tc qdisc add dev veth_pub root netem loss 3% delay 80ms

          OUTFILE=/tmp/hypha_listen_quic.txt
          rm -f "$OUTFILE"

          sudo ip netns exec hypha_sub env RUST_LOG=info \
            timeout 45s ./target/debug/examples/netem_node sub quic 10.20.0.2 /tmp/hypha_sub_quic "$OUTFILE" &
          SUB_PID=$!

          for _ in $(seq 1 50); do
            if [ -s "$OUTFILE" ]; then
              break
            fi
            sleep 0.1
          done
          if [ ! -s "$OUTFILE" ]; then
            echo "subscriber did not write listen addr"
            kill "$SUB_PID" || true
            exit 1
          fi

          PEER_ADDR="$(<"$OUTFILE")"
          echo "Dialing: $PEER_ADDR"

          sudo ip netns exec hypha_pub env RUST_LOG=info \
            timeout 30s ./target/debug/examples/netem_node pub quic 10.20.0.1 /tmp/hypha_pub_quic "$PEER_ADDR"

          wait "$SUB_PID"

      - name: Netns line topology (TCP) pub→relay→sub
        timeout-minutes: 6
        shell: bash
        run: |
          set -euo pipefail

          sudo ip netns add hypha_pub
          sudo ip netns add hypha_relay
          sudo ip netns add hypha_sub

          cleanup() {
            sudo ip netns del hypha_pub 2>/dev/null || true
            sudo ip netns del hypha_relay 2>/dev/null || true
            sudo ip netns del hypha_sub 2>/dev/null || true
            sudo ip link del br_hypha 2>/dev/null || true
          }
          trap cleanup EXIT

          sudo ip link add name br_hypha type bridge
          sudo ip link set br_hypha up

          # pub
          sudo ip link add veth_pub type veth peer name veth_pub_br
          sudo ip link set veth_pub netns hypha_pub
          sudo ip link set veth_pub_br master br_hypha
          sudo ip link set veth_pub_br up
          sudo ip -n hypha_pub addr add 10.30.0.1/24 dev veth_pub
          sudo ip -n hypha_pub link set lo up
          sudo ip -n hypha_pub link set veth_pub up

          # relay
          sudo ip link add veth_relay type veth peer name veth_relay_br
          sudo ip link set veth_relay netns hypha_relay
          sudo ip link set veth_relay_br master br_hypha
          sudo ip link set veth_relay_br up
          sudo ip -n hypha_relay addr add 10.30.0.2/24 dev veth_relay
          sudo ip -n hypha_relay link set lo up
          sudo ip -n hypha_relay link set veth_relay up

          # sub
          sudo ip link add veth_sub type veth peer name veth_sub_br
          sudo ip link set veth_sub netns hypha_sub
          sudo ip link set veth_sub_br master br_hypha
          sudo ip link set veth_sub_br up
          sudo ip -n hypha_sub addr add 10.30.0.3/24 dev veth_sub
          sudo ip -n hypha_sub link set lo up
          sudo ip -n hypha_sub link set veth_sub up

          # netem: make pub noisy; relay clean; sub mildly delayed.
          sudo ip netns exec hypha_pub tc qdisc add dev veth_pub root netem loss 8% delay 40ms
          sudo ip netns exec hypha_sub tc qdisc add dev veth_sub root netem delay 20ms

          SUB_OUT=/tmp/hypha_line_sub_tcp.txt
          RELAY_OUT=/tmp/hypha_line_relay_tcp.txt
          rm -f "$SUB_OUT" "$RELAY_OUT"

          sudo ip netns exec hypha_sub env RUST_LOG=info \
            timeout 60s ./target/debug/examples/netem_node sub tcp 10.30.0.3 /tmp/hypha_line_sub_tcp "$SUB_OUT" &
          SUB_PID=$!

          # Wait for sub addr.
          for _ in $(seq 1 50); do
            if [ -s "$SUB_OUT" ]; then break; fi
            sleep 0.1
          done
          if [ ! -s "$SUB_OUT" ]; then
            echo "sub did not write addr"
            kill "$SUB_PID" || true
            exit 1
          fi
          SUB_ADDR="$(<"$SUB_OUT")"

          sudo ip netns exec hypha_relay env RUST_LOG=info \
            timeout 60s ./target/debug/examples/netem_node relay tcp 10.30.0.2 /tmp/hypha_line_relay_tcp "$RELAY_OUT" "$SUB_ADDR" 6000 &
          RELAY_PID=$!

          # Wait for relay addr.
          for _ in $(seq 1 50); do
            if [ -s "$RELAY_OUT" ]; then break; fi
            sleep 0.1
          done
          if [ ! -s "$RELAY_OUT" ]; then
            echo "relay did not write addr"
            kill "$SUB_PID" || true
            kill "$RELAY_PID" || true
            exit 1
          fi
          RELAY_ADDR="$(<"$RELAY_OUT")"

          sudo ip netns exec hypha_pub env RUST_LOG=info \
            timeout 30s ./target/debug/examples/netem_node pub tcp 10.30.0.1 /tmp/hypha_line_pub_tcp "$RELAY_ADDR"

          wait "$SUB_PID"
          wait "$RELAY_PID"

      - name: Netns line topology (QUIC) pub→relay→sub
        timeout-minutes: 6
        shell: bash
        run: |
          set -euo pipefail

          sudo ip netns add hypha_pub
          sudo ip netns add hypha_relay
          sudo ip netns add hypha_sub

          cleanup() {
            sudo ip netns del hypha_pub 2>/dev/null || true
            sudo ip netns del hypha_relay 2>/dev/null || true
            sudo ip netns del hypha_sub 2>/dev/null || true
            sudo ip link del br_hypha 2>/dev/null || true
          }
          trap cleanup EXIT

          sudo ip link add name br_hypha type bridge
          sudo ip link set br_hypha up

          # pub
          sudo ip link add veth_pub type veth peer name veth_pub_br
          sudo ip link set veth_pub netns hypha_pub
          sudo ip link set veth_pub_br master br_hypha
          sudo ip link set veth_pub_br up
          sudo ip -n hypha_pub addr add 10.40.0.1/24 dev veth_pub
          sudo ip -n hypha_pub link set lo up
          sudo ip -n hypha_pub link set veth_pub up

          # relay
          sudo ip link add veth_relay type veth peer name veth_relay_br
          sudo ip link set veth_relay netns hypha_relay
          sudo ip link set veth_relay_br master br_hypha
          sudo ip link set veth_relay_br up
          sudo ip -n hypha_relay addr add 10.40.0.2/24 dev veth_relay
          sudo ip -n hypha_relay link set lo up
          sudo ip -n hypha_relay link set veth_relay up

          # sub
          sudo ip link add veth_sub type veth peer name veth_sub_br
          sudo ip link set veth_sub netns hypha_sub
          sudo ip link set veth_sub_br master br_hypha
          sudo ip link set veth_sub_br up
          sudo ip -n hypha_sub addr add 10.40.0.3/24 dev veth_sub
          sudo ip -n hypha_sub link set lo up
          sudo ip -n hypha_sub link set veth_sub up

          # netem: pub noisy; sub delayed.
          sudo ip netns exec hypha_pub tc qdisc add dev veth_pub root netem loss 5% delay 90ms
          sudo ip netns exec hypha_sub tc qdisc add dev veth_sub root netem delay 40ms

          SUB_OUT=/tmp/hypha_line_sub_quic.txt
          RELAY_OUT=/tmp/hypha_line_relay_quic.txt
          rm -f "$SUB_OUT" "$RELAY_OUT"

          sudo ip netns exec hypha_sub env RUST_LOG=info \
            timeout 60s ./target/debug/examples/netem_node sub quic 10.40.0.3 /tmp/hypha_line_sub_quic "$SUB_OUT" &
          SUB_PID=$!

          for _ in $(seq 1 50); do
            if [ -s "$SUB_OUT" ]; then break; fi
            sleep 0.1
          done
          if [ ! -s "$SUB_OUT" ]; then
            echo "sub did not write addr"
            kill "$SUB_PID" || true
            exit 1
          fi
          SUB_ADDR="$(<"$SUB_OUT")"

          sudo ip netns exec hypha_relay env RUST_LOG=info \
            timeout 60s ./target/debug/examples/netem_node relay quic 10.40.0.2 /tmp/hypha_line_relay_quic "$RELAY_OUT" "$SUB_ADDR" 6000 &
          RELAY_PID=$!

          for _ in $(seq 1 50); do
            if [ -s "$RELAY_OUT" ]; then break; fi
            sleep 0.1
          done
          if [ ! -s "$RELAY_OUT" ]; then
            echo "relay did not write addr"
            kill "$SUB_PID" || true
            kill "$RELAY_PID" || true
            exit 1
          fi
          RELAY_ADDR="$(<"$RELAY_OUT")"

          sudo ip netns exec hypha_pub env RUST_LOG=info \
            timeout 30s ./target/debug/examples/netem_node pub quic 10.40.0.1 /tmp/hypha_line_pub_quic "$RELAY_ADDR"

          wait "$SUB_PID"
          wait "$RELAY_PID"
